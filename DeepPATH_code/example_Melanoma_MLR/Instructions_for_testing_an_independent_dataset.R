####load libraries
library(tidyverse)
library(dplyr)
library(survival)
library(survminer)
library(ggpubr)
library(pROC)
library(ggplot2)

####test set
##spreadsheet can be excel or csv

##required columns: dcnn prediction, baseline ecog, treatment category, response code, pfs, time to pfs
#dcnn prediction: prediction score is generated by logistic regression
#baseline ecog
#treatment category
#response to treatment (can call column "response_code"): 0 = response and 1 = progression

##before uploading to R, create a new column for the logistic regression prediction using the formula below. call this column "logistic"
#Logit(p)= -0.4970 + (2.0966*DCNN output) + (1.2522*ECOG) – (1.8908*Anti-CTLA-4 and Anti-PD-1 status) – (1.2013*Anti-PD-1 status). 

##after creating this new column with corresponding logistic regression, import the import test set spreadsheet 
test

##specify labels of the ROC curve
labels <- c("DCNN","DCNN + Clinical Data")

##generate and run test set roc curve
test_roc <- roc(test$response_code, test$logistic)
test_roc 

#set optimal cut point, which we determined for our model using the training dataset and closest to the top left point
CUT=0.7395212 #spec: 0.8372093 #sen: 0.6410256

####risk stratification
##patients whose prediction is above the optimal cut point are considered high risk
##patients whose prediction is below the optimal cut point are considered low risk
test$risk = ifelse(test$logistic>=CUT, 'High', 'Low')

####create km curves
test_fit <- survfit(Surv(time_to_pfs, pfs)~risk, data=test)
km_test <-ggsurvplot(test_fit, data = test,
                     title="DCNN + Clinical Data",
                     pval = T, pval.coord = c(0,0.03),
                     risk.table = F,
                     legend.labs = c("High Risk", "Low Risk"),
                     conf.int = F,
                     xlim=c(0,500),
                     xlab = c('Time (Days)'),
                     ylab = c('PFS Probability'),
                     font.legend = list(size=20),
                     font.x=c(20), 
                     font.y=c(20), 
                     font.tickslab=c(15),
                     pval.size = 6,
                     font.title=c(25))
km_test